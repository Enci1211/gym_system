{% extends "admin/admin.html" %}
{% block title %}
memberprofile
{% endblock %}
{% block content %}

<style>
    /* body {
        color: #404E67;
        background: #F5F7FA;
        font-family: 'Open Sans', sans-serif;
    } */
    
    .table-wrapper {
        width: 100%;
        margin: 30px auto;
        background: #fff;
        padding: 20px;	
        box-shadow: 0 1px 1px rgba(0,0,0,.05);
    }
    .table-title {
        padding-bottom: 10px;
        margin: 0 0 10px;
        justify-content: space-between;
        align-items: center;
    }
    .table-title h2 {
        margin: 3px 0 0;
        font-size: 22px;
    }
    
    .btn-group {
        display: inline;
        float: right;
        align-items: center;
    }

    .col-lg-6{
        margin-right: 4px;
        align-items: center;
        float: middle;
        font-size: 15px;
        margin-bottom: 10px;
    }

    .col-lg-6 input{
        height: 30px;
        border-radius: 3px;
        border: 1px solid #0e0e0e;
        font-size: 18px;
     
    }

    table.table {
        
        width: 100%;
    }
    table.table tr th, table.table tr td {
        border-color: #e9e9e9;
    }
    table.table th i {
        font-size: px;
        margin: 0 5px;
        cursor: pointer;
    }
    table.table th:last-child {
        width: 100px;
    }
    table.table td a {
        cursor: pointer;
        display: inline-block;
        margin: 0 5px;
        min-width: 24px;
        align-items: center;
    }
    table.table td a:hover {
	color: #2196F3;
    }    
    table.table td a.add {
        color: #27C46B;
    }
    table.table td a.edit {
        color: #FFC107;
    }
    table.table td a.delete {
        color: #E34724;
    }
    table.table td i {
        font-size: 19px;
    }
    table.table td a.add i {
        font-size: 24px;
        margin-right: -1px;
        position: relative;
        top: 3px;
    }    
    table.table .form-control {
        height: 32px;
        line-height: 32px;
        box-shadow: none;
        border-radius: 2px;
        font-size: 2rem;
    }
    table.table .form-control.error {
        border-color: #f50000;
    }
    table.table td .add {
        display: none;
    }
   
/* Modal styles */
.modal .modal-dialog {
	max-width: 400px;
}
.modal .modal-header, .modal .modal-body, .modal .modal-footer {
	padding: 20px 30px;
}
.modal .modal-content {
	border-radius: 3px;
	font-size: 14px;
}
.modal .modal-footer {
	background: #ecf0f1;
	border-radius: 0 0 3px 3px;
}
.modal .modal-title {
	display: inline-block;
}
.modal .form-control {
	border-radius: 2px;
	box-shadow: none;
	border-color: #dddddd;
}
.modal textarea.form-control {
	resize: vertical;
}
.modal .btn {
	border-radius: 2px;
	min-width: 100px;
}	
.modal form label {
	font-weight: normal;
}	
</style>


<script>
    $(document).ready(function(){
        $('[data-toggle="tooltip"]').tooltip();
        var actions = $("table td:last-child").html();
        // Append table with add row form on add new button click
        /* $(".add-new").click(function(){
            $(this).attr("disabled", "disabled");
            var index = $("table tbody tr:last-child").index();
            var row = '<tr>' +
                '<td><input type="text" class="form-control" name="name" id="name"></td>' +
                '<td><input type="text" class="form-control" name="email" id="email"></td>' +
                '<td><input type="text" class="form-control" name="phone" id="phone"></td>' +
                '<td><input type="text" class="form-control" name="address" id="address"></td>' +
                '<td>' + actions + '</td>' +
            '</tr>';
            $("table").append(row);		
            $("table tbody tr").eq(index + 1).find(".add, .edit").toggle();
            $('[data-toggle="tooltip"]').tooltip();
        }); */

        // add search bar
        $(document).ready(function(){
        $("#search").on("keyup", function() {
            var value = $(this).val().toLowerCase();
            $("tbody tr").filter(function() {
                $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
            });
        });
    });
   
         // Add status filiter to the table
         const filterButtons = document.querySelectorAll('.filter-btn');
        const memberTable = document.querySelector('#member-table');

        filterButtons.forEach((btn) => {
         btn.addEventListener('click', () => {
        const filterValue = btn.getAttribute('data-filter');

        memberTable.querySelectorAll('tbody tr').forEach((row) => {
        if (filterValue === 'all' || row.getAttribute('data-status') === filterValue) {
          row.classList.remove('d-none');
        } else {
          row.classList.add('d-none');
        }
      });
    });
  });
            
        // Add row on add button click
        $(document).on("click", ".add", function(){
            var empty = false;
            var input = $(this).parents("tr").find('input[type="text"]');
            input.each(function(){
                if(!$(this).val()){
                    $(this).addClass("error");
                    empty = true;
                } else{
                    $(this).removeClass("error");
                }
            });
            $(this).parents("tr").find(".error").first().focus();
            if(!empty){
                input.each(function(){
                    $(this).parent("td").html($(this).val());
                });			
                $(this).parents("tr").find(".add, .edit").toggle();
                $(".add-new").removeAttr("disabled");
            }		
        }); 
       
        
/* $(document).on("click", ".edit", function() {
  // get the member id of the row
  var member_id = $(this).closest('tr').find('td:eq(0)').text();
  console.log('Member ID:', member_id);

  $(this).parents("tr").find("td:not(:last-child)").each(function() {
   
    $(this).html('<input type="text" class="form-control" value="' + $(this).text() + '">');
    var input=$(this).find('input').focus().val();
    console.log('input:', input);
  });
  $(this).parents("tr").find(".add, .edit").toggle();
  $(".add-new").attr("disabled", "disabled");
}); */

// Edit row on edit button click
$(document).on("click", ".edit", function() {
  // get the member id of the row
  var member_id = $(this).closest('tr').find('td:eq(0)').text();
  console.log('Member ID:', member_id);

  $(this).parents("tr").find(".email, .phone, .address").each(function() {
    $(this).html('<input type="text" class="form-control" value="' + $(this).text() + '">');
    var input=$(this).find('input').focus().val();
    console.log('input:', input);
  });

  $(this).parents("tr").find(".add, .edit").toggle();
  $(".add-new").attr("disabled", "disabled");
});



// Save row on add button click
$(document).on("click", ".add", function() {
  // get the member id of the row
    var member_id = $(this).closest('tr').find('.member-id').val();
    var email = $(this).closest('tr').find('.email').text();
    console.log('email:', email);

    var phone = $(this).closest('tr').find('.phone').text();
    console.log('phone:', phone);
    var address = $(this).closest('tr').find('.address').text();
    console.log('address:', address);

  // create a data object to hold the updated values
  var data = {
    'member_id': member_id,
    'email': email,
    'phone': phone,
    'address': address
  };

  // send the data object in the AJAX request
  var row = $(this).closest('tr');
  if (phone) {
        if(isNaN(phone) || phone.length > 10){
            alert('Phone number must be a number and less than 10 digits');
            valid = false;
        }
    }
if (valid) {
    $.ajax({
    url: '/admin/memberprofile/update',
    type: 'POST',
    data: data,
    success: function(response) {
     
        if (email) {
        row.find('td:eq(2)').text(email);
      }

      if (phone) {
        row.find('td:eq(3)').text(phone);
      }
      if (address) {
        row.find('td:eq(4)').text(address);
      }

      row.find(".add, .edit").toggle();
      $(".add-new").removeAttr("disabled");
    },
        error: function(error) {
            console.log(error.responseText);
        }
    });
}
});

// Show delete confirmation modal

$(document).ready(function() {
// Show modal with member ID when delete button is clicked
$('.delete').click(function(){
    var memberID = $(this).attr('data-id');
    var status = $(this).closest('tr').attr('data-status');
    
    if (status === 'active') {
        alert('Warning: You can not delete an Active member.');
    } else {
        console.log('Member ID:', memberID);
        $('#id').val(memberID);
        $('#deletememberModal').modal('show');
        console.log('Delete button clicked');
    }
});

  // Add click event listener to Cancel button
  $('#deleteForm input[type="button"]').on('click', function() {
    console.log('Cancel button clicked');
    // Close the modal dialog
    $('#deletememberModal').modal('hide');
  });
  
// Add submit event listener to Delete button
$('#deleteForm').on('submit', function(event) {
    // Prevent the default form submission behavior
    event.preventDefault();

    // Get the member ID from the hidden input field
    var member_id = $('#id').val();
    console.log('Member ID:', member_id);
    
    // Send an AJAX request to delete the member
    $.ajax({
      url: '/admin/memberprofile/delete',
      type: 'POST',
      data: {
        id: member_id
      },
      success: function(data) {
        // Close the modal dialog
        $('#deletememberModal').modal('hide');
        
        // Reload the member profile page
        window.location.reload();
      },
      error: function() {
        // Show an error message
        alert('An error occurred while deleting the member.');
      }
    });
  });   
});
});
</script>

<section>
<div class="home">
        <div class="content">
            <div class="table-wrapper">
                <div class="table-title">
                    <div class="row">
                        <div class="col-sm-8"><h2>Member List</h2></div>
                    </div>
                </div>
                <!-- <div class="btn-group" data-toggle="buttons" >
                    <label class="btn btn-info active">
                        <input type="radio" name="Status" value="all" checked="checked"> All
                     </label>
                    <label class="btn btn-success">
                        <input type="radio" name="Status" value="Active"> Active
                    </label>
                    <label class="btn btn-warning">
                        <input type="radio" name="Status" value="Inactive"> Inactive
                    </label>						
                </div> -->
                <div class="btn-group btn-group-lg ">
                    <button type="button" class="btn btn-info filter-btn btn-lg" data-filter="all">All</button>
                    <button type="button" class="btn btn-success filter-btn btn-lg" data-filter="active">Active</button>
                    <button type="button" class="btn btn-warning filter-btn btn-lg" data-filter="inactive">Inactive</button>
                  </div>
                  
                <div class="col-lg-6">
                    <input type="text" class="form-control" id="search" placeholder="Search by name or Member ID">
                </div>
                <table id="member-table" class="table table-bordered  table-striped table-hover table align-middle">
                    <thead class="table-dark align-middle">
                        <tr>
                            <th>Member ID</th>
                            <th>Full Name</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Address</th>
                            <th>DOB</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for member in memberlist %}
                        <tr data-status="{% if member[8] == 1 %}active{% else %}inactive{% endif %}" >
                            <td> {{member[0]}} </td>
                            <td>{{member[2]}} {{member[3]}} </td>
                            <td class="email">{{member[4]}} </td>
                            <td class="phone">{{member[5]}} </td>
                            <td class="address">{{member[6]}} </td>
                            <td >{{member[7]}} </td>
                            <td>
                                {% if member[8] == 1 %}
                                    <span class="badge bg-success"> Active </span> 
                                {% else %}
                                    <span class="badge bg-warning"> Inactive </span>
                                {% endif %}
                            </td>
                            <td>
                                <input type="hidden" class="member-id" value="{{ member[0] }}">
                                <a class="add" title="Add" data-toggle="tooltip" data-id="{{ member[0] }}"><i class="material-icons">check</i></a>
                                <a href="#" class="edit" data-toggle="tooltip" data-placement="top" title="Edit"><i class="material-icons">&#xE254;</i></a>
                                <a class="delete" data-toggle="modal" data-target="#deletememberModal" data-id="{{ member[0] }}"><i class="material-icons">&#xE872;</i></a>
                                <a href="/admin/attendance/?memberid={{member[0]}}"> <i class="material-icons">&#xEa77;</i></a>
                            </td>
                        </tr>
                        {% endfor %} 
                    </tbody>
                </table>
                <!-- <div class="clearfix">
                    <div class="hint-text">Showing <b>{{ memberlist|length }}</b> out of <b> 11 </b> entries</div>
                    <ul class="pagination">
                        <li class="page-item disabled"><a href="#">Previous</a></li>
                        <li class="page-item"><a href="#" class="page-link">1</a></li>
                        <li class="page-item"><a href="#" class="page-link">2</a></li>
                        <li class="page-item active"><a href="#" class="page-link">3</a></li>
                        <li class="page-item"><a href="#" class="page-link">4</a></li>
                        <li class="page-item"><a href="#" class="page-link">5</a></li>
                        <li class="page-item"><a href="#" class="page-link">Next</a></li>
                    </ul>
                </div> -->
            </div>
        </div>        
    
    <!-- Delete Modal HTML -->
    <div class="modal fade" id="deletememberModal" tabindex="-1" aria-labelledby="deletememberModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deletememberModalLabel">Delete Member</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <p>Are you sure you want to delete this member?</p>
              </div>
              <div class="modal-footer">
                <form id="deleteForm" method="POST" action="/admin/memberprofile/delete">
                    <input type="hidden" id="id" name="id">
                    <input type="button" class="btn btn-secondary" data-bs-dismiss="modal" value="Cancel">
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
                </div> 
          </div>
        </div>
      </div>
</div>      
</section>            
{% endblock %}